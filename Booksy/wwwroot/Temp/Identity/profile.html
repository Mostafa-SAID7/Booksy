<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Booksy — User Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">

    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden grid grid-cols-1 md:grid-cols-3">

        <!-- Sidebar -->
        <aside class="p-6 bg-gradient-to-tr from-indigo-600 to-indigo-400 text-white md:col-span-1">
            <h1 class="text-3xl font-semibold">Booksy</h1>
            <p class="mt-2 text-indigo-100">Manage your profile, preferences and contact info.</p>
            <nav class="mt-6 space-y-2">
                <button data-target="profile" class="panel-switch block w-full text-left px-3 py-2 rounded bg-white/10">Profile</button>
                <button data-target="security" class="panel-switch block w-full text-left px-3 py-2 rounded bg-white/10">Security</button>
                <button data-target="preferences" class="panel-switch block w-full text-left px-3 py-2 rounded bg-white/10">Preferences</button>
            </nav>
        </aside>

        <!-- Panels -->
        <main class="p-8 md:col-span-2">
            <div id="feedback" class="mb-4 text-sm hidden"></div>

            <!-- Profile Panel -->
            <form id="panel-profile" class="panel space-y-4 hidden">
                <h2 class="text-xl font-semibold">Personal Info</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium">First Name</label>
                        <input id="firstName" type="text" class="w-full px-4 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Last Name</label>
                        <input id="lastName" type="text" class="w-full px-4 py-2 border rounded" />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium">Full Name</label>
                    <input id="name" type="text" class="w-full px-4 py-2 border rounded" />
                </div>
                <div>
                    <label class="block text-sm font-medium">Email</label>
                    <input id="email" type="email" class="w-full px-4 py-2 border rounded" />
                </div>
                <div>
                    <label class="block text-sm font-medium">Phone Number</label>
                    <input id="phoneNumber" type="text" class="w-full px-4 py-2 border rounded" />
                </div>

                <h2 class="text-xl font-semibold mt-6">Address</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium">Street</label>
                        <input id="street" type="text" class="w-full px-4 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium">City</label>
                        <input id="city" type="text" class="w-full px-4 py-2 border rounded" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium">State</label>
                        <input id="state" type="text" class="w-full px-4 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Zip Code</label>
                        <input id="zipCode" type="text" class="w-full px-4 py-2 border rounded" />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium">Country</label>
                    <input id="country" type="text" class="w-full px-4 py-2 border rounded" />
                </div>

                <div class="flex gap-4 mt-6">
                    <button id="btn-save-profile" type="submit" class="flex-1 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Save Changes</button>
                    <button id="btn-refresh-profile" type="button" class="flex-1 py-2 rounded border border-gray-300 hover:bg-gray-100">Refresh</button>
                </div>
            </form>

            <!-- Security Panel -->
            <form id="panel-security" class="panel hidden space-y-4">
                <h2 class="text-xl font-semibold">Security</h2>
                <p class="text-sm text-gray-600">Change password and manage security settings.</p>
                <!-- Could add Change Password fields here -->
            </form>

            <!-- Preferences Panel -->
            <form id="panel-preferences" class="panel hidden space-y-4">
                <h2 class="text-xl font-semibold">Preferences</h2>
                <div class="grid grid-cols-2 gap-4 items-center">
                    <div>
                        <label class="block text-sm font-medium">Preferred Language</label>
                        <select id="preferredLanguage" class="w-full px-4 py-2 border rounded">
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2 mt-6">
                        <input id="receiveNewsletter" type="checkbox" class="form-checkbox h-4 w-4" />
                        <span class="text-sm">Receive Newsletter</span>
                    </div>
                </div>
            </form>

        </main>
    </div>

    <script>
        const apiBase = "https://localhost:5001/api/Identity/Profiles";
        const panels = document.querySelectorAll('.panel');
        const feedbackEl = document.getElementById('feedback');

        function showFeedback(msg, type = 'info') {
            feedbackEl.textContent = msg || '';
            feedbackEl.className = 'mb-4 text-sm px-3 py-2 rounded';
            if (!msg) return feedbackEl.classList.add('hidden');
            if (type === 'error') feedbackEl.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-100');
            else if (type === 'success') feedbackEl.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-100');
            else feedbackEl.classList.add('bg-blue-50', 'text-sky-700', 'border', 'border-sky-100');
            feedbackEl.classList.remove('hidden');
        }

        function showPanel(name) {
            panels.forEach(p => p.classList.add('hidden'));
            const el = document.getElementById('panel-' + name);
            if (el) el.classList.remove('hidden');
            showFeedback('');
        }

        document.querySelectorAll('.panel-switch').forEach(btn => btn.addEventListener('click', () => showPanel(btn.dataset.target)));
        showPanel('profile'); // default panel

        async function fetchJson(url, options = {}) {
            const res = await fetch(url, options);
            const text = await res.text();
            let json = null;
            try { json = text ? JSON.parse(text) : null } catch { }
            if (!res.ok) throw new Error(json?.msg || text || res.statusText);
            return json;
        }

        async function loadProfile() {
            try {
                const profile = await fetchJson(apiBase, { method: 'GET', credentials: 'include' });
                document.getElementById('firstName').value = profile.firstName || '';
                document.getElementById('lastName').value = profile.lastName || '';
                document.getElementById('name').value = profile.name || '';
                document.getElementById('email').value = profile.email || '';
                document.getElementById('phoneNumber').value = profile.phoneNumber || '';
                document.getElementById('street').value = profile.street || '';
                document.getElementById('city').value = profile.city || '';
                document.getElementById('state').value = profile.state || '';
                document.getElementById('zipCode').value = profile.zipCode || '';
                document.getElementById('country').value = profile.country || '';
                document.getElementById('preferredLanguage').value = profile.preferredLanguage || 'en';
                document.getElementById('receiveNewsletter').checked = !!profile.receiveNewsletter;
                showFeedback('Profile loaded', 'success');
            } catch (err) {
                console.error(err); showFeedback(err.message, 'error');
            }
        }

        document.getElementById('btn-save-profile').addEventListener('click', async ev => {
            ev.preventDefault();
            const payload = {
                Name: document.getElementById('name').value.trim(),
                FirstName: document.getElementById('firstName').value.trim(),
                LastName: document.getElementById('lastName').value.trim(),
                Email: document.getElementById('email').value.trim(),
                PhoneNumber: document.getElementById('phoneNumber').value.trim(),
                Street: document.getElementById('street').value.trim(),
                City: document.getElementById('city').value.trim(),
                State: document.getElementById('state').value.trim(),
                ZipCode: document.getElementById('zipCode').value.trim(),
                Country: document.getElementById('country').value.trim(),
                PreferredLanguage: document.getElementById('preferredLanguage').value,
                ReceiveNewsletter: document.getElementById('receiveNewsletter').checked
            };
            try {
                await fetchJson(apiBase + '/Update', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                showFeedback('Profile updated successfully!', 'success');
            } catch (err) {
                console.error(err); showFeedback(err.message, 'error');
            }
        });

        document.getElementById('btn-refresh-profile').addEventListener('click', loadProfile);

        // Initial load
        loadProfile();
    </script>

</body>
</html>
