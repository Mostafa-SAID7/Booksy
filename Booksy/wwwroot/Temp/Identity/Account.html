<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Booksy — Accounts (fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden grid grid-cols-1 md:grid-cols-2">
        <aside class="p-8 bg-gradient-to-tr from-indigo-600 to-indigo-400 text-white">
            <h1 class="text-3xl font-semibold">Booksy</h1>
            <p class="mt-2 text-indigo-100">Authentication panel — Register, Login, Reset password, Confirm email.</p>
            <nav class="mt-6 space-y-2">
                <button data-target="login" class="panel-switch block w-full text-left px-3 py-2 rounded bg-white/10">Login</button>
                <button data-target="register" class="panel-switch block w-full text-left px-3 py-2 rounded bg-white/10">Register</button>
                <button data-target="resend" class="panel-switch block w-full text-left px-3 py-2 rounded bg-white/10">Resend</button>
                <button data-target="forget" class="panel-switch block w-full text-left px-3 py-2 rounded bg-white/10">Forgot (OTP)</button>
                <button data-target="reset" class="panel-switch block w-full text-left px-3 py-2 rounded bg-white/10">Verify OTP</button>
                <button data-target="newpass" class="panel-switch block w-full text-left px-3 py-2 rounded bg-white/10">Set New Password</button>
                <button data-target="confirm" class="panel-switch block w-full text-left px-3 py-2 rounded bg-white/10">Confirm Email</button>
            </nav>
        </aside>

        <main class="p-8">
            <div id="feedback" class="mb-4 text-sm"></div>

            <!-- Login -->
            <form id="panel-login" class="panel hidden space-y-4" onsubmit="return false;">
                <h2 class="text-xl font-semibold">Login</h2>
                <input id="login-email" required type="text" placeholder="Email or Username" class="w-full px-4 py-2 border rounded" />
                <input id="login-password" required type="password" placeholder="Password" class="w-full px-4 py-2 border rounded" />
                <label class="inline-flex items-center gap-2">
                    <input id="login-remember" type="checkbox" class="form-checkbox h-4 w-4" />
                    <span class="text-sm">Remember me</span>
                </label>
                <div class="flex gap-2">
                    <button id="btn-login" class="flex-1 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Login</button>
                    <button type="button" data-target="forget" class="py-2 px-4 rounded border">Forgot?</button>
                </div>
            </form>

            <!-- Register (with ConfirmPassword) -->
            <form id="panel-register" class="panel hidden space-y-4" onsubmit="return false;">
                <h2 class="text-xl font-semibold">Register</h2>
                <input id="reg-name" required type="text" placeholder="Full name" class="w-full px-4 py-2 border rounded" />
                <input id="reg-username" required type="text" placeholder="Username" class="w-full px-4 py-2 border rounded" />
                <input id="reg-email" required type="email" placeholder="Email" class="w-full px-4 py-2 border rounded" />
                <input id="reg-password" required type="password" placeholder="Password" class="w-full px-4 py-2 border rounded" />
                <input id="reg-confirm-password" required type="password" placeholder="Confirm Password" class="w-full px-4 py-2 border rounded" />
                <div id="reg-pass-error" class="text-sm text-red-600 hidden">Passwords do not match.</div>

                <div class="grid grid-cols-2 gap-2">
                    <input id="reg-city" type="text" placeholder="City" class="px-4 py-2 border rounded" />
                    <input id="reg-state" type="text" placeholder="State" class="px-4 py-2 border rounded" />
                    <input id="reg-street" type="text" placeholder="Street" class="px-4 py-2 border rounded col-span-2" />
                    <input id="reg-zipcode" type="text" placeholder="Zip Code" class="px-4 py-2 border rounded col-span-2" />
                </div>

                <div class="flex gap-2">
                    <button id="btn-register" class="flex-1 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Register</button>
                    <button type="button" data-target="login" class="py-2 px-4 rounded border">Back</button>
                </div>
            </form>

            <!-- Resend -->
            <form id="panel-resend" class="panel hidden space-y-4" onsubmit="return false;">
                <h2 class="text-xl font-semibold">Resend Confirmation</h2>
                <input id="resend-identity" required type="text" placeholder="Email or Username" class="w-full px-4 py-2 border rounded" />
                <div class="flex gap-2">
                    <button id="btn-resend" class="flex-1 py-2 rounded bg-yellow-600 text-white">Resend</button>
                    <button type="button" data-target="login" class="py-2 px-4 rounded border">Back</button>
                </div>
            </form>

            <!-- Forget -->
            <form id="panel-forget" class="panel hidden space-y-4" onsubmit="return false;">
                <h2 class="text-xl font-semibold">Forgot Password — Send OTP</h2>
                <input id="forget-identity" required type="text" placeholder="Email or Username" class="w-full px-4 py-2 border rounded" />
                <div class="flex gap-2">
                    <button id="btn-forget" class="flex-1 py-2 rounded bg-rose-600 text-white">Send OTP</button>
                    <button type="button" data-target="reset" class="py-2 px-4 rounded border">Have OTP?</button>
                </div>
            </form>

            <!-- Reset -->
            <form id="panel-reset" class="panel hidden space-y-4" onsubmit="return false;">
                <h2 class="text-xl font-semibold">Verify OTP</h2>
                <input id="reset-userid" required type="text" placeholder="ApplicationUserId (from response/email)" class="w-full px-4 py-2 border rounded" />
                <input id="reset-otp" required type="text" placeholder="OTP number" class="w-full px-4 py-2 border rounded" />
                <div class="flex gap-2">
                    <button id="btn-reset" class="flex-1 py-2 rounded bg-purple-600 text-white">Verify OTP</button>
                    <button type="button" data-target="newpass" class="py-2 px-4 rounded border">Next</button>
                </div>
            </form>

            <!-- New password (with Confirm) -->
            <form id="panel-newpass" class="panel hidden space-y-4" onsubmit="return false;">
                <h2 class="text-xl font-semibold">Set New Password</h2>
                <input id="new-userid" required type="text" placeholder="ApplicationUserId" class="w-full px-4 py-2 border rounded" />
                <input id="new-password" required type="password" placeholder="New Password" class="w-full px-4 py-2 border rounded" />
                <input id="new-confirm-password" required type="password" placeholder="Confirm New Password" class="w-full px-4 py-2 border rounded" />
                <div id="new-pass-error" class="text-sm text-red-600 hidden">Passwords do not match.</div>
                <div class="flex gap-2">
                    <button id="btn-newpass" class="flex-1 py-2 rounded bg-pink-600 text-white">Set Password</button>
                    <button type="button" data-target="login" class="py-2 px-4 rounded border">Back</button>
                </div>
            </form>

            <!-- Confirm email -->
            <form id="panel-confirm" class="panel hidden space-y-4" onsubmit="return false;">
                <h2 class="text-xl font-semibold">Confirm Email (token)</h2>
                <input id="confirm-userid" required type="text" placeholder="UserId" class="w-full px-4 py-2 border rounded" />
                <input id="confirm-token" required type="text" placeholder="Encoded token (from email link)" class="w-full px-4 py-2 border rounded" />
                <div class="flex gap-2">
                    <button id="btn-confirm" class="flex-1 py-2 rounded bg-sky-600 text-white">Confirm</button>
                    <button type="button" data-target="login" class="py-2 px-4 rounded border">Back</button>
                </div>
            </form>
        </main>
    </div>

    <script>
        const apiBase = "https://localhost:5001/api/Identity/Accounts";
        const panels = document.querySelectorAll('.panel');
        const feedbackEl = document.getElementById('feedback');

        function showFeedback(message, type = 'error') {
            feedbackEl.textContent = message || '';
            feedbackEl.className = '';
            feedbackEl.classList.add('mb-4', 'text-sm', 'px-3', 'py-2', 'rounded');
            if (!message) { feedbackEl.classList.add('hidden'); return; }
            if (type === 'error') feedbackEl.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-100');
            else if (type === 'success') feedbackEl.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-100');
            else feedbackEl.classList.add('bg-blue-50', 'text-sky-700', 'border', 'border-sky-100');
        }

        function showPanel(name) {
            panels.forEach(p => p.classList.add('hidden'));
            const el = document.getElementById('panel-' + name);
            if (el) el.classList.remove('hidden');
            showFeedback('', 'info');
            document.getElementById('reg-pass-error').classList.add('hidden');
            document.getElementById('new-pass-error').classList.add('hidden');
        }

        async function fetchJson(url, options = {}) {
            console.debug('fetch', url, options);
            const res = await fetch(url, options);
            const text = await res.text().catch(() => '');
            let json = null;
            try { json = text ? JSON.parse(text) : null; } catch (e) { }
            if (!res.ok) {
                let message = '';
                if (Array.isArray(json)) message = json.map(it => it.description || it.Description || JSON.stringify(it)).join('; ');
                else if (json && json.errors) {
                    if (Array.isArray(json.errors)) message = json.errors.join('; ');
                    else if (typeof json.errors === 'object') message = Object.values(json.errors).flat().join('; ');
                    else message = String(json.errors);
                } else if (json && (json.msg || json.Msg)) message = json.msg || json.Msg;
                else if (json) message = Object.values(json).flat ? Object.values(json).flat().join('; ') : JSON.stringify(json);
                else message = text || res.status + ' ' + res.statusText;
                const err = new Error(message);
                err.payload = json || text; err.status = res.status;
                throw err;
            }
            return json;
        }

        function setButtonLoading(btn, isLoading) {
            if (!btn) return;
            btn.disabled = isLoading;
            if (isLoading) { btn.dataset.prev = btn.innerHTML; btn.innerHTML = 'Processing…'; }
            else { if (btn.dataset.prev) { btn.innerHTML = btn.dataset.prev; delete btn.dataset.prev; } }
        }

        document.querySelectorAll('.panel-switch').forEach(btn => btn.addEventListener('click', () => showPanel(btn.dataset.target)));
        document.querySelectorAll('button[data-target]').forEach(b => b.addEventListener('click', () => showPanel(b.dataset.target)));
        showPanel('login');

        // Password match helpers
        function validateRegisterPasswords() {
            const p = document.getElementById('reg-password').value;
            const c = document.getElementById('reg-confirm-password').value;
            const err = document.getElementById('reg-pass-error');
            if (!p || !c) { err.classList.add('hidden'); return true; }
            if (p !== c) { err.classList.remove('hidden'); return false; }
            err.classList.add('hidden'); return true;
        }
        function validateNewPasswords() {
            const p = document.getElementById('new-password').value;
            const c = document.getElementById('new-confirm-password').value;
            const err = document.getElementById('new-pass-error');
            if (!p || !c) { err.classList.add('hidden'); return true; }
            if (p !== c) { err.classList.remove('hidden'); return false; }
            err.classList.add('hidden'); return true;
        }
        ['reg-password', 'reg-confirm-password'].forEach(id => document.getElementById(id).addEventListener('input', validateRegisterPasswords));
        ['new-password', 'new-confirm-password'].forEach(id => document.getElementById(id).addEventListener('input', validateNewPasswords));

        // --- LOGIN (note: removed credentials: 'include' to avoid wildcard-CORS failure during local dev)
        // --- LOGIN
        document.getElementById('btn-login').addEventListener('click', async (ev) => {
            ev.preventDefault();
            const btn = ev.currentTarget;
            showFeedback('', 'info');
            const EmailOrUserName = document.getElementById('login-email').value.trim();
            const Password = document.getElementById('login-password').value;
            const RememberMe = !!document.getElementById('login-remember').checked;
            if (!EmailOrUserName || !Password) return showFeedback('Please fill username/email and password.', 'error');

            const payload = { EmailOrUserName, Password, RememberMe };
            setButtonLoading(btn, true);
            try {
                const res = await fetchJson(`${apiBase}/Login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                    // credentials: 'include'  // re-enable if your API uses cookies
                });

                showFeedback(res?.msg || 'Login successful', 'success');

                localStorage.setItem("access_token", res.token);
                window.location.href = "profile.html";
            } catch (err) {
                console.error(err);
                showFeedback(err.message || 'Login failed', 'error');
            } finally { setButtonLoading(btn, false); }
        });


        // --- REGISTER: includes ConfirmPassword in body
        document.getElementById('btn-register').addEventListener('click', async (ev) => {
            ev.preventDefault();
            const btn = ev.currentTarget;
            showFeedback('', 'info');
            if (!validateRegisterPasswords()) return showFeedback('Passwords do not match.', 'error');

            const payload = {
                Name: document.getElementById('reg-name').value.trim(),
                UserName: document.getElementById('reg-username').value.trim(),
                Email: document.getElementById('reg-email').value.trim(),
                Password: document.getElementById('reg-password').value,
                ConfirmPassword: document.getElementById('reg-confirm-password').value, // <<--- send ConfirmPassword
                City: document.getElementById('reg-city').value.trim(),
                State: document.getElementById('reg-state').value.trim(),
                Street: document.getElementById('reg-street').value.trim(),
                ZipCode: document.getElementById('reg-zipcode').value.trim()
            };

            if (!payload.Name || !payload.UserName || !payload.Email || !payload.Password) {
                return showFeedback('Name, Username, Email and Password are required.', 'error');
            }

            setButtonLoading(btn, true);
            try {
                const res = await fetchJson(`${apiBase}/Register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                showFeedback(res?.msg || 'Registered successfully — check your email for confirmation.', 'success');
            } catch (err) {
                console.error(err);
                showFeedback(err.message || 'Registration failed', 'error');
            } finally { setButtonLoading(btn, false); }
        });

        // --- RESEND
        document.getElementById('btn-resend').addEventListener('click', async (ev) => {
            ev.preventDefault();
            const btn = ev.currentTarget; showFeedback('', 'info');
            const EmailOrUserName = document.getElementById('resend-identity').value.trim();
            if (!EmailOrUserName) return showFeedback('Please enter email or username.', 'error');
            setButtonLoading(btn, true);
            try {
                const res = await fetchJson(`${apiBase}/ResendEmailConfirmation`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ EmailOrUserName })
                });
                showFeedback(res?.msg || 'Confirmation email resent.', 'success');
            } catch (err) { console.error(err); showFeedback(err.message || 'Resend failed', 'error'); } finally { setButtonLoading(btn, false); }
        });

        // --- FORGET / OTP send
        document.getElementById('btn-forget').addEventListener('click', async (ev) => {
            ev.preventDefault(); const btn = ev.currentTarget; showFeedback('', 'info');
            const EmailOrUserName = document.getElementById('forget-identity').value.trim();
            if (!EmailOrUserName) return showFeedback('Please enter email or username.', 'error');
            setButtonLoading(btn, true);
            try {
                const res = await fetchJson(`${apiBase}/ForgetPassword`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ EmailOrUserName })
                });
                showFeedback(res?.msg || 'OTP sent', 'success');
                if (res?.userId) { document.getElementById('reset-userid').value = res.userId; showPanel('reset'); }
            } catch (err) { console.error(err); showFeedback(err.message || 'Error sending OTP', 'error'); } finally { setButtonLoading(btn, false); }
        });

        // --- RESET verify OTP
        document.getElementById('btn-reset').addEventListener('click', async (ev) => {
            ev.preventDefault(); const btn = ev.currentTarget; showFeedback('', 'info');
            const ApplicationUserId = document.getElementById('reset-userid').value.trim();
            const OTPNumber = document.getElementById('reset-otp').value.trim();
            if (!ApplicationUserId || !OTPNumber) return showFeedback('Please provide ApplicationUserId and OTP.', 'error');
            setButtonLoading(btn, true);
            try {
                const res = await fetchJson(`${apiBase}/ResetPassword`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ApplicationUserId, OTPNumber })
                });
                showFeedback(res?.msg || 'OTP verified', 'success');
                if (res?.userId) { document.getElementById('new-userid').value = res.userId; showPanel('newpass'); }
            } catch (err) { console.error(err); showFeedback(err.message || 'OTP verification failed', 'error'); } finally { setButtonLoading(btn, false); }
        });

        // --- NEW PASSWORD (send ConfirmPassword too just in case)
        document.getElementById('btn-newpass').addEventListener('click', async (ev) => {
            ev.preventDefault(); const btn = ev.currentTarget; showFeedback('', 'info');
            if (!validateNewPasswords()) return showFeedback('Passwords do not match.', 'error');
            const ApplicationUserId = document.getElementById('new-userid').value.trim();
            const Password = document.getElementById('new-password').value;
            const ConfirmPassword = document.getElementById('new-confirm-password').value;
            if (!ApplicationUserId || !Password) return showFeedback('Please provide user id and new password.', 'error');
            setButtonLoading(btn, true);
            try {
                const res = await fetchJson(`${apiBase}/NewPassword`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    // include ConfirmPassword in case the DTO requires it
                    body: JSON.stringify({ ApplicationUserId, Password, ConfirmPassword })
                });
                showFeedback(res?.msg || 'Password changed successfully', 'success');
                showPanel('login');
            } catch (err) { console.error(err); showFeedback(err.message || 'Failed to set new password', 'error'); } finally { setButtonLoading(btn, false); }
        });

        // --- CONFIRM EMAIL (GET)
        document.getElementById('btn-confirm').addEventListener('click', async (ev) => {
            ev.preventDefault(); const btn = ev.currentTarget; showFeedback('', 'info');
            const userId = document.getElementById('confirm-userid').value.trim();
            const token = document.getElementById('confirm-token').value.trim();
            if (!userId || !token) return showFeedback('Please enter both userId and token.', 'error');
            setButtonLoading(btn, true);
            try {
                const url = new URL(`${apiBase}/ConfirmEmail`);
                url.searchParams.set('token', token); url.searchParams.set('userId', userId);
                const r = await fetch(url.toString(), { method: 'GET' });
                const text = await r.text().catch(() => ''); let json = null; try { json = text ? JSON.parse(text) : null; } catch { }
                if (!r.ok) { let message = json?.msg || text || r.statusText; throw new Error(message); }
                showFeedback(json?.msg || 'Email confirmed', 'success'); showPanel('login');
            } catch (err) { console.error(err); showFeedback(err.message || 'Confirm failed', 'error'); } finally { setButtonLoading(btn, false); }
        });
    </script>
</body>
</html>
